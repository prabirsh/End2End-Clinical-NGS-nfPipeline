/*
========================================================================================
    Nextflow Configuration File
    Maintained by: Prabir
========================================================================================
*/

// Global default params
params {
    // Analysis parameters
    analysis_type = 'germline'  // Options: germline, somatic_paired, somatic_tumor_only
    sample_sheet = null
    outdir = 'results'
    
    // Reference files
    reference_genome = null
    target_bed = null
    known_sites = null  // For BQSR (e.g., dbSNP, known INDELs)
    
    // Variant calling
    variant_caller = 'gatk'  // Options: gatk (HaplotypeCaller for germline, Mutect2 for somatic)
    pon = null  // Panel of Normals for tumor-only analysis
    gnomad_common = null
    dbsnp = null
    
    // Quality thresholds
    min_base_quality = 20
    min_mapping_quality = 20
    min_variant_depth = 50  // Germline
    min_vaf_germline = 0.20  // Minimum VAF for germline variants
    min_vaf_somatic = 0.05  // Minimum VAF for somatic variants (paired)
    min_vaf_tumor_only = 0.10  // Minimum VAF for tumor-only
    
    // Coverage analysis
    coverage_thresholds = [1, 10, 20, 30, 50, 100]
    min_coverage = 50
    
    // CNV analysis
    enable_cnv_analysis = false
    
    // Resource allocation
    max_cpus = 16
    max_memory = '64.GB'
    max_time = '48.h'
}

// Process configurations
process {
    // Default resources
    cpus = 4
    memory = '16.GB'
    time = '6.h'
    
    // Error handling
    errorStrategy = 'retry'
    maxRetries = 2
    
    // Process-specific resources
    withLabel: 'fastqc' {
        cpus = 2
        memory = '4.GB'
        time = '1.h'
    }
    
    withLabel: 'alignment' {
        cpus = 8
        memory = '32.GB'
        time = '12.h'
    }
    
    withLabel: 'variant_calling' {
        cpus = 8
        memory = '32.GB'
        time = '8.h'
    }
    
    withLabel: 'annotation' {
        cpus = 4
        memory = '16.GB'
        time = '4.h'
    }
}

// Execution profiles
profiles {
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
        
        process {
            container = 'broadinstitute/gatk:latest'
        }
    }
    
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        
        process {
            container = 'docker://broadinstitute/gatk:latest'
        }
    }
    
    conda {
        conda.enabled = true
        process.conda = "${baseDir}/environment.yml"
    }
    
    local {
        executor = 'local'
        process.executor = 'local'
    }
    
    slurm {
        executor = 'slurm'
        queue = 'batch'
        
        process {
            executor = 'slurm'
            clusterOptions = '--qos=normal'
        }
    }
}

// Reporting
timeline {
    enabled = true
    file = "${params.outdir}/timeline.html"
}

report {
    enabled = true
    file = "${params.outdir}/report.html"
}

trace {
    enabled = true
    file = "${params.outdir}/trace.txt"
}

dag {
    enabled = true
    file = "${params.outdir}/dag.svg"
}

// Manifest
manifest {
    name = 'Clinical NGS Pipeline'
    author = 'Prabir'
    version = '2.0'
    description = 'Production-grade NGS analysis pipeline for clinical applications'
    mainScript = 'main.nf'
    defaultBranch = 'main'
    nextflowVersion = '>=22.10.0'
}
